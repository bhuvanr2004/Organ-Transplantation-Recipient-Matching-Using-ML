{% extends "base.html" %}

{% block title %}Add Recipient - OrganMatch{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    #recipientMap {
        height: 400px;
        width: 100%;
        border-radius: 10px;
        margin-bottom: 1rem;
    }
    .location-info {
        background: rgba(16, 185, 129, 0.1);
        padding: 1rem;
        border-radius: 10px;
        margin-top: 1rem;
    }
</style>
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-user-injured" style="background: linear-gradient(135deg, #10b981, #059669); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i> Add New Recipient
            </h1>
            <p class="page-subtitle">Register a new organ recipient in the system</p>
        </div>

        <div class="glass-card">
            <form method="POST" action="{{ url_for('add_recipient') }}">
                <h3 class="section-title">
                    <i class="fas fa-user"></i> Basic Information
                </h3>
                
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label class="form-label">Name <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-user"></i></span>
                            <input type="text" class="form-control" name="name" placeholder="Enter full name" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Age</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                            <input type="number" class="form-control" name="age" min="0" max="120" placeholder="Age in years">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Gender</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-venus-mars"></i></span>
                            <select class="form-select" name="gender">
                                <option value="">Select gender...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <h3 class="section-title">
                    <i class="fas fa-heartbeat"></i> Medical Information
                </h3>
                
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Blood Group</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-tint"></i></span>
                            <select class="form-select" name="blood_group">
                                <option value="">Select blood group...</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Organ Needed <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-heart"></i></span>
                            <select class="form-select" name="organ_needed" required>
                                <option value="">Select organ needed...</option>
                                <option value="Heart">Heart</option>
                                <option value="Kidney">Kidney</option>
                                <option value="Liver">Liver</option>
                                <option value="Lung">Lung</option>
                                <option value="Pancreas">Pancreas</option>
                                <option value="Intestine">Intestine</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label">BMI (kg/mÂ²)</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-weight"></i></span>
                            <input type="number" class="form-control" name="bmi" step="0.1" min="0" placeholder="Body Mass Index">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">HLA Typing</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-dna"></i></span>
                            <input type="text" class="form-control" name="hla_typing" placeholder="A1,B8,DR3">
                        </div>
                    </div>
                </div>
                
                <h3 class="section-title">
                    <i class="fas fa-map-marker-alt"></i> Location Information
                </h3>
                
                <div class="mb-4">
                    <p class="text-muted mb-3">
                        <i class="fas fa-info-circle"></i> Click on the map to set your location, use the button below to get your current location, or enter coordinates manually.
                    </p>
                    
                    <button type="button" class="btn btn-gradient mb-3" style="background: linear-gradient(135deg, #10b981, #059669);" id="getCurrentLocation">
                        <i class="fas fa-crosshairs"></i> Get Current Location
                    </button>
                    
                    <div id="recipientMap"></div>
                    
                    <div class="row g-3 mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Latitude</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-location-dot"></i></span>
                                <input type="number" class="form-control" name="latitude" id="latitude" step="0.000001" placeholder="e.g., 40.712776" min="-90" max="90">
                            </div>
                            <small class="text-muted d-block mt-1">Range: -90 to 90</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Longitude</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-location-dot"></i></span>
                                <input type="number" class="form-control" name="longitude" id="longitude" step="0.000001" placeholder="e.g., -74.005974" min="-180" max="180">
                            </div>
                            <small class="text-muted d-block mt-1">Range: -180 to 180</small>
                        </div>
                    </div>
                    
                    <div class="location-info" id="locationInfo" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-map-pin text-success me-2"></i>
                            <div>
                                <strong>Selected Location:</strong><br>
                                <span id="coordsDisplay">No location selected</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h3 class="section-title">
                    <i class="fas fa-exclamation-triangle"></i> Urgency & Requirements
                </h3>
                
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Organ Size Needed (grams/ml)</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-ruler"></i></span>
                            <input type="number" class="form-control" name="organ_size_needed" step="1" min="0" placeholder="Required size in grams or ml">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Urgency Level (1-10) <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-exclamation-circle"></i></span>
                            <select class="form-select" name="urgency_level" required>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5" selected>5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <h3 class="section-title">
                    <i class="fas fa-notes-medical"></i> Medical Conditions
                </h3>
                
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="form-check" style="padding: 15px; background: rgba(16, 185, 129, 0.05); border-radius: 10px;">
                            <input class="form-check-input" type="checkbox" name="diabetes" value="1" id="diabetes">
                            <label class="form-check-label fw-semibold" for="diabetes">
                                <i class="fas fa-syringe text-danger"></i> Diabetes
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check" style="padding: 15px; background: rgba(16, 185, 129, 0.05); border-radius: 10px;">
                            <input class="form-check-input" type="checkbox" name="hypertension" value="1" id="hypertension">
                            <label class="form-check-label fw-semibold" for="hypertension">
                                <i class="fas fa-heartbeat text-warning"></i> Hypertension
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="action-button-group mt-4">
                    <button type="submit" class="btn btn-gradient btn-lg" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <i class="fas fa-save"></i> Add Recipient
                    </button>
                    <a href="{{ url_for('recipients') }}" class="btn btn-outline-gradient btn-lg">
                        <i class="fas fa-arrow-left"></i> Back to Recipients
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let recipientMap;
    let marker;
    
    function initMap() {
        recipientMap = L.map('recipientMap').setView([20, 0], 2);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(recipientMap);
        
        recipientMap.on('click', function(e) {
            setLocation(e.latlng.lat, e.latlng.lng);
        });
    }
    
    function setLocation(lat, lng) {
        if (marker) {
            recipientMap.removeLayer(marker);
        }
        
        marker = L.marker([lat, lng]).addTo(recipientMap);
        recipientMap.setView([lat, lng], 13);
        
        document.getElementById('latitude').value = lat.toFixed(6);
        document.getElementById('longitude').value = lng.toFixed(6);
        
        document.getElementById('locationInfo').style.display = 'block';
        document.getElementById('coordsDisplay').textContent = 
            `Latitude: ${lat.toFixed(6)}, Longitude: ${lng.toFixed(6)}`;
    }
    
    function updateMapFromInputs() {
        const lat = parseFloat(document.getElementById('latitude').value);
        const lng = parseFloat(document.getElementById('longitude').value);
        
        if (!isNaN(lat) && !isNaN(lng)) {
            if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                setLocation(lat, lng);
            } else {
                alert('Invalid coordinates. Latitude must be between -90 and 90, Longitude must be between -180 and 180.');
            }
        }
    }
    
    document.getElementById('latitude').addEventListener('change', updateMapFromInputs);
    document.getElementById('longitude').addEventListener('change', updateMapFromInputs);
    
    document.getElementById('getCurrentLocation').addEventListener('click', function() {
        if (navigator.geolocation) {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting location...';
            this.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    setLocation(position.coords.latitude, position.coords.longitude);
                    this.innerHTML = '<i class="fas fa-crosshairs"></i> Get Current Location';
                    this.disabled = false;
                },
                (error) => {
                    alert('Unable to retrieve your location. Please click on the map to set your location manually.');
                    this.innerHTML = '<i class="fas fa-crosshairs"></i> Get Current Location';
                    this.disabled = false;
                }
            );
        } else {
            alert('Geolocation is not supported by your browser. Please click on the map to set your location manually.');
        }
    });
    
    initMap();
});
</script>
{% endblock %}
