{% extends "base.html" %}

{% block title %}Compatibility Matches - OrganMatch{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-link" style="background: linear-gradient(135deg, #f59e0b, #d97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i> Compatibility Matches
    </h1>
    <p class="page-subtitle">ML-predicted donor-recipient compatibility scores powered by Random Forest algorithm</p>
</div>

<div class="glass-card mb-4">
    <div class="table-responsive">
        <table class="table table-modern">
            <thead>
                <tr>
                    <th style="width: 8%;">Donor ID</th>
                    <th style="width: 12%;">Donor Name</th>
                    <th style="width: 8%;">Recipient ID</th>
                    <th style="width: 12%;">Recipient Name</th>
                    <th style="width: 10%;">Organ Name</th>
                    <th style="width: 10%;">Blood Compatible</th>
                    <th style="width: 10%;">HLA Match %</th>
                    <th style="width: 10%;">Storage Score</th>
                    <th style="width: 8%;">Urgency</th>
                    <th style="width: 10%;">Final Match %</th>
                    <th style="width: 8%;">Details</th>
                </tr>
            </thead>
            <tbody>
                {% for match in matches %}
                <tr>
                    <td><span class="badge badge-info">#{{ match.donor.id }}</span></td>
                    <td><strong>{{ match.donor.name }}</strong></td>
                    <td><span class="badge badge-info">#{{ match.recipient.id }}</span></td>
                    <td><strong>{{ match.recipient.name }}</strong></td>
                    <td><strong style="color: #667eea;"><i class="fas fa-heart"></i> {{ match.donor.organ_type }}</strong></td>
                    <td>
                        {% if match.factors.blood_compatible %}
                            <span class="compatibility-high"><i class="fas fa-check-circle"></i> Compatible</span>
                        {% else %}
                            <span class="compatibility-low"><i class="fas fa-times-circle"></i> Incompatible</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if match.factors.hla_percentage >= 75 %}
                            <span class="compatibility-high"><i class="fas fa-dna"></i> {{ match.factors.hla_percentage }}%</span>
                        {% elif match.factors.hla_percentage >= 50 %}
                            <span class="compatibility-medium"><i class="fas fa-dna"></i> {{ match.factors.hla_percentage }}%</span>
                        {% else %}
                            <span class="compatibility-low"><i class="fas fa-dna"></i> {{ match.factors.hla_percentage }}%</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if match.factors.storage_score >= 70 %}
                            <span class="compatibility-high"><i class="fas fa-snowflake"></i> {{ match.factors.storage_score }}</span>
                        {% elif match.factors.storage_score >= 40 %}
                            <span class="compatibility-medium"><i class="fas fa-clock"></i> {{ match.factors.storage_score }}</span>
                        {% else %}
                            <span class="compatibility-low"><i class="fas fa-exclamation-triangle"></i> {{ match.factors.storage_score }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% set urgency = match.factors.urgency_level %}
                        {% if urgency == 10 %}
                            <span class="compatibility-high"><strong>{{ urgency }}/10</strong> <i class="fas fa-check-circle"></i></span>
                        {% elif urgency >= 8 %}
                            <span class="compatibility-medium"><strong>{{ urgency }}/10</strong> <i class="fas fa-exclamation"></i></span>
                        {% elif urgency >= 5 %}
                            <span class="compatibility-medium"><strong>{{ urgency }}/10</strong></span>
                        {% else %}
                            <span class="compatibility-low"><strong>{{ urgency }}/10</strong></span>
                        {% endif %}
                    </td>
                    <td>
                        {% if match.compatibility >= 80 %}
                            <span class="compatibility-high"><i class="fas fa-check-circle"></i> <strong>{{ match.compatibility }}%</strong></span>
                        {% elif match.compatibility >= 50 %}
                            <span class="compatibility-medium"><i class="fas fa-exclamation-circle"></i> <strong>{{ match.compatibility }}%</strong></span>
                        {% else %}
                            <span class="compatibility-low"><i class="fas fa-times-circle"></i> <strong>{{ match.compatibility }}%</strong></span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-gradient" onclick="toggleDetails({{ loop.index0 }})">
                            <i class="fas fa-chevron-down"></i> View
                        </button>
                    </td>
                </tr>
                <tr class="details-row" id="details-{{ loop.index0 }}" style="display: none;">
                    <td colspan="11">
                        <div class="compatibility-details">
                            <div class="details-grid">
                                <!-- Primary Factors -->
                                <div class="detail-section">
                                    <h5><i class="fas fa-star"></i> Primary Factors</h5>
                                    <div class="factor-item">
                                        <div class="factor-label">Blood Group Compatible</div>
                                        <div class="factor-value">
                                            {% if match.factors.blood_compatible %}
                                                <span class="badge badge-success">YES - Donor: {{ match.donor.blood_group }} → Recipient: {{ match.recipient.blood_group }}</span>
                                            {% else %}
                                                <span class="badge badge-danger">NO - Donor: {{ match.donor.blood_group }} → Recipient: {{ match.recipient.blood_group }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="factor-item">
                                        <div class="factor-label">HLA Genetic Match</div>
                                        <div class="factor-value">
                                            <div class="progress" style="height: 20px; margin: 5px 0;">
                                                <div class="progress-bar" role="progressbar" style="width: {{ match.factors.hla_percentage }}%; background: linear-gradient(90deg, #667eea, #764ba2);" aria-valuenow="{{ match.factors.hla_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                                    {{ match.factors.hla_percentage }}%
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="factor-item">
                                        <div class="factor-label">Organ Storage Freshness</div>
                                        <div class="factor-value">
                                            <div class="progress" style="height: 20px; margin: 5px 0;">
                                                <div class="progress-bar" role="progressbar" style="width: {{ match.factors.storage_score }}%; background: linear-gradient(90deg, #667eea, #764ba2);" aria-valuenow="{{ match.factors.storage_score }}" aria-valuemin="0" aria-valuemax="100">
                                                    {{ match.factors.storage_score }}%
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Medical Factors -->
                                <div class="detail-section">
                                    <h5><i class="fas fa-heart"></i> Medical Factors</h5>
                                    <div class="factor-item">
                                        <div class="factor-label">Donor Medical Risk</div>
                                        <div class="factor-value">
                                            <span class="badge badge-{{ 'danger' if match.factors.donor_medical_risk > 50 else 'warning' if match.factors.donor_medical_risk > 25 else 'success' }}">
                                                {{ match.factors.donor_medical_risk | int }}%
                                            </span>
                                        </div>
                                    </div>
                                    <div class="factor-item">
                                        <div class="factor-label">Recipient Medical Risk</div>
                                        <div class="factor-value">
                                            <span class="badge badge-{{ 'danger' if match.factors.recipient_medical_risk > 50 else 'warning' if match.factors.recipient_medical_risk > 25 else 'success' }}">
                                                {{ match.factors.recipient_medical_risk | int }}%
                                            </span>
                                        </div>
                                    </div>
                                    <div class="factor-item">
                                        <div class="factor-label">Gender Compatibility</div>
                                        <div class="factor-value">
                                            <span class="badge badge-info">{{ match.factors.gender_compatible | int }}%</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Physical Factors -->
                                <div class="detail-section">
                                    <h5><i class="fas fa-ruler"></i> Physical Factors</h5>
                                    <div class="factor-item">
                                        <div class="factor-label">Age Difference</div>
                                        <div class="factor-value">
                                            <span class="badge badge-primary">{{ match.factors.age_difference }} years</span>
                                            (Donor: {{ match.donor.age }} | Recipient: {{ match.recipient.age }})
                                        </div>
                                    </div>
                                    <div class="factor-item">
                                        <div class="factor-label">Organ Size Difference</div>
                                        <div class="factor-value">
                                            <span class="badge badge-primary">{{ match.factors.organ_size_difference }} units</span>
                                            (Donor: {{ match.factors.donor_bmi | replace('N/A', 'Not provided') }} | Recipient needed: {{ match.factors.recipient_bmi | replace('N/A', 'Not provided') }})
                                        </div>
                                    </div>
                                    <div class="factor-item">
                                        <div class="factor-label">Geographical Distance</div>
                                        <div class="factor-value">
                                            {% if match.factors.distance_km %}
                                                <span class="badge badge-primary"><i class="fas fa-map-marker-alt"></i> {{ match.factors.distance_km }} km</span>
                                            {% else %}
                                                <span class="badge badge-secondary">Location data unavailable</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- BMI Factors -->
                                <div class="detail-section">
                                    <h5><i class="fas fa-weight"></i> BMI Indicators</h5>
                                    <div class="factor-item">
                                        <div class="factor-label">Donor BMI</div>
                                        <div class="factor-value">
                                            <span class="badge badge-secondary">{{ match.factors.donor_bmi }}</span>
                                        </div>
                                    </div>
                                    <div class="factor-item">
                                        <div class="factor-label">Recipient BMI</div>
                                        <div class="factor-value">
                                            <span class="badge badge-secondary">{{ match.factors.recipient_bmi }}</span>
                                        </div>
                                    </div>
                                    <div class="factor-item">
                                        <div class="factor-label">Recipient Urgency Level</div>
                                        <div class="factor-value">
                                            <span class="badge badge-{{ 'danger' if match.factors.urgency_level >= 8 else 'warning' if match.factors.urgency_level >= 5 else 'success' }}">
                                                {{ match.factors.urgency_level }}/10
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Final Score Summary -->
                            <div class="final-score-summary">
                                <h5>AI Prediction Summary</h5>
                                <div class="score-display">
                                    <div class="large-score {% if match.compatibility >= 80 %}score-excellent{% elif match.compatibility >= 50 %}score-good{% else %}score-poor{% endif %}">
                                        {{ match.compatibility }}%
                                    </div>
                                    <div class="score-description">
                                        {% if match.compatibility >= 80 %}
                                            <strong>EXCELLENT MATCH</strong> - Highly recommended for transplant consideration
                                        {% elif match.compatibility >= 50 %}
                                            <strong>GOOD MATCH</strong> - Consider for transplant with careful evaluation
                                        {% else %}
                                            <strong>POOR MATCH</strong> - Alternative matches recommended
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="11" class="text-center text-muted py-5">
                        <i class="fas fa-link fa-3x mb-3 d-block" style="opacity: 0.3;"></i>
                        <h5>No matches found</h5>
                        <p class="text-muted">Please ensure you have both donors and recipients in the system.</p>
                        <div class="action-button-group" style="justify-content: center; margin-top: 20px;">
                            <a href="{{ url_for('add_donor') }}" class="btn btn-gradient"><i class="fas fa-plus"></i> Add Donor</a>
                            <a href="{{ url_for('add_recipient') }}" class="btn btn-gradient"><i class="fas fa-plus"></i> Add Recipient</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-4">
        <div class="stat-card success">
            <div class="d-flex align-items-center">
                <div class="icon-box me-3" style="background: linear-gradient(135deg, #10b981, #059669); width: 50px; height: 50px; font-size: 1.5rem;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div>
                    <div class="stat-label">Excellent Match</div>
                    <div class="stat-number" style="font-size: 1.8rem; color: #10b981;">80-100%</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card warning">
            <div class="d-flex align-items-center">
                <div class="icon-box me-3" style="background: linear-gradient(135deg, #f59e0b, #d97706); width: 50px; height: 50px; font-size: 1.5rem;">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div>
                    <div class="stat-label">Good Match</div>
                    <div class="stat-number" style="font-size: 1.8rem; color: #f59e0b;">50-79%</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card" style="border-left-color: #ef4444;">
            <div class="d-flex align-items-center">
                <div class="icon-box me-3" style="background: linear-gradient(135deg, #ef4444, #dc2626); width: 50px; height: 50px; font-size: 1.5rem;">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div>
                    <div class="stat-label">Poor Match</div>
                    <div class="stat-number" style="font-size: 1.8rem; color: #ef4444;">0-49%</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.details-row {
    background-color: #f8f9fa;
}

.compatibility-details {
    padding: 20px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
    border-radius: 10px;
    margin: 10px 0;
}

.details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.detail-section {
    background: white;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #667eea;
}

.detail-section h5 {
    margin-bottom: 15px;
    color: #333;
    font-size: 1.1rem;
}

.factor-item {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.factor-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.factor-label {
    font-weight: 600;
    color: #555;
    font-size: 0.9rem;
    margin-bottom: 5px;
}

.factor-value {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.progress {
    border-radius: 5px;
    background-color: #eee;
}

.progress-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.9rem;
    font-weight: bold;
}

.final-score-summary {
    background: white;
    padding: 20px;
    border-radius: 8px;
    border: 2px solid #667eea;
    text-align: center;
}

.final-score-summary h5 {
    margin-bottom: 15px;
}

.score-display {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.large-score {
    font-size: 3rem;
    font-weight: bold;
    min-width: 120px;
    padding: 20px;
    border-radius: 10px;
    color: white;
}

.score-excellent {
    background: linear-gradient(135deg, #10b981, #059669);
}

.score-good {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.score-poor {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.score-description {
    font-size: 1.1rem;
    color: #555;
}

.badge {
    display: inline-block;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.85rem;
}

.badge-success {
    background-color: #d1e7dd;
    color: #0c3027;
}

.badge-danger {
    background-color: #f8d7da;
    color: #842029;
}

.badge-warning {
    background-color: #fff3cd;
    color: #664d03;
}

.badge-primary {
    background-color: #d1ecf1;
    color: #0c5460;
}

.badge-secondary {
    background-color: #e2e3e5;
    color: #383d41;
}

.badge-info {
    background-color: #d1ecf1;
    color: #0c5460;
}
</style>

<script>
function toggleDetails(index) {
    const detailsRow = document.getElementById('details-' + index);
    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
    } else {
        detailsRow.style.display = 'none';
    }
}
</script>
{% endblock %}
