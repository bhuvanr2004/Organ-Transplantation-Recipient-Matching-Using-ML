{% extends "base.html" %}

{% block title %}System Logs - OrganMatch{% endblock %}

{% block extra_css %}
<style>
    .log-container {
        background: #1e1e1e;
        border-radius: 8px;
        padding: 0;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }
    
    .terminal-header {
        background: #2d2d2d;
        padding: 10px 15px;
        border-bottom: 1px solid #404040;
        font-size: 13px;
        color: #aaa;
        font-weight: 500;
    }
    
    .terminal-body {
        background: #1e1e1e;
        padding: 15px;
        max-height: 600px;
        overflow-y: auto;
    }
    
    .log-entry {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.6;
        margin-bottom: 2px;
        color: #d4d4d4;
    }
    
    .log-success .log-message {
        color: #4ec9b0;
    }
    
    .log-info .log-message {
        color: #9cdcfe;
    }
    
    .log-warning .log-message {
        color: #dcdcaa;
    }
    
    .log-error .log-message {
        color: #f48771;
    }
    
    .log-timestamp {
        color: #858585;
        margin-right: 10px;
    }
    
    .log-category {
        display: none;
    }
    
    .log-message {
        word-break: break-word;
    }
    
    .filter-buttons {
        margin-bottom: 20px;
    }
    
    .filter-btn {
        margin-right: 8px;
        margin-bottom: 8px;
    }
    
    .clear-logs-btn {
        float: right;
    }
    
    .no-logs {
        text-align: center;
        padding: 60px 20px;
        color: #858585;
    }
    
    .no-logs i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.3;
    }
    
    .auto-refresh-toggle {
        display: inline-block;
        margin-left: 15px;
    }
    
    .auto-refresh-toggle label {
        color: #333;
    }
    
    .pagination-container {
        margin-top: 20px;
        display: flex;
        justify-content: center;
    }
    
    .terminal-body::-webkit-scrollbar {
        width: 10px;
    }
    
    .terminal-body::-webkit-scrollbar-track {
        background: #1e1e1e;
    }
    
    .terminal-body::-webkit-scrollbar-thumb {
        background: #404040;
        border-radius: 5px;
    }
    
    .terminal-body::-webkit-scrollbar-thumb:hover {
        background: #4a4a4a;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-5 fw-bold mb-4">
            <i class="fas fa-scroll"></i> System Logs
        </h1>
    </div>
</div>

<div class="filter-buttons">
    <button class="btn btn-sm btn-outline-primary filter-btn" onclick="filterLogs('all')">
        <i class="fas fa-list"></i> All
    </button>
    <button class="btn btn-sm btn-outline-success filter-btn" onclick="filterLogs('success')">
        <i class="fas fa-check-circle"></i> Success
    </button>
    <button class="btn btn-sm btn-outline-info filter-btn" onclick="filterLogs('info')">
        <i class="fas fa-info-circle"></i> Info
    </button>
    <button class="btn btn-sm btn-outline-warning filter-btn" onclick="filterLogs('warning')">
        <i class="fas fa-exclamation-triangle"></i> Warnings
    </button>
    <button class="btn btn-sm btn-outline-danger filter-btn" onclick="filterLogs('error')">
        <i class="fas fa-times-circle"></i> Errors
    </button>
    
    <button class="btn btn-sm btn-danger clear-logs-btn" onclick="clearLogs()">
        <i class="fas fa-trash"></i> Clear Logs
    </button>
    
    <div class="auto-refresh-toggle">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
            <label class="form-check-label" for="autoRefresh">
                <i class="fas fa-sync-alt"></i> Auto-refresh (5s)
            </label>
        </div>
    </div>
</div>

<div class="log-container">
    <div class="terminal-header">
        <i class="fas fa-terminal"></i> System Logs Terminal
    </div>
    <div class="terminal-body" id="logsContainer">
        {% if logs.items %}
            {% for log in logs.items %}
            <div class="log-entry log-{{ log.level }}" data-level="{{ log.level }}">
                <span class="log-timestamp">{{ log.timestamp.strftime('%H:%M:%S') }}</span>
                <span class="log-message">{{ log.message }}</span>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-logs">
                <i class="fas fa-inbox"></i>
                <div style="color: #858585;">No logs available</div>
                <div style="color: #606060; font-size: 12px;">Logs will appear when model training occurs</div>
            </div>
        {% endif %}
    </div>
    
    {% if logs.pages > 1 %}
    <div class="pagination-container">
        <nav>
            <ul class="pagination">
                {% if logs.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('logs', page=logs.prev_num) }}">Previous</a>
                </li>
                {% endif %}
                
                {% for page_num in logs.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                    {% if page_num %}
                        <li class="page-item {{ 'active' if page_num == logs.page }}">
                            <a class="page-link" href="{{ url_for('logs', page=page_num) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}
                
                {% if logs.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('logs', page=logs.next_num) }}">Next</a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<script>
let autoRefreshInterval = null;

function filterLogs(level) {
    const allLogs = document.querySelectorAll('.log-entry');
    allLogs.forEach(log => {
        if (level === 'all' || log.dataset.level === level) {
            log.style.display = 'block';
        } else {
            log.style.display = 'none';
        }
    });
}

function clearLogs() {
    if (confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
        fetch('/api/logs/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert(data.message);
                location.reload();
            } else if (data.error) {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error clearing logs: ' + error);
        });
    }
}

function refreshLogs() {
    fetch('/api/logs?limit=100')
        .then(response => response.json())
        .then(logs => {
            const container = document.getElementById('logsContainer');
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="no-logs">
                        <i class="fas fa-inbox"></i>
                        <div style="color: #858585;">No logs available</div>
                        <div style="color: #606060; font-size: 12px;">Logs will appear when model training occurs</div>
                    </div>
                `;
            } else {
                container.innerHTML = logs.map(log => {
                    const timestamp = log.timestamp.split(' ')[1] || log.timestamp;
                    return `
                    <div class="log-entry log-${log.level}" data-level="${log.level}">
                        <span class="log-timestamp">${timestamp}</span>
                        <span class="log-message">${log.message}</span>
                    </div>
                `}).join('');
            }
        })
        .catch(error => {
            console.error('Error refreshing logs:', error);
        });
}

function toggleAutoRefresh() {
    const checkbox = document.getElementById('autoRefresh');
    if (checkbox.checked) {
        autoRefreshInterval = setInterval(refreshLogs, 5000);
    } else {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }
}
</script>
{% endblock %}
